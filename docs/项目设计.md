# 雷霆战机游戏 - 项目设计文档

## 项目概述

一个基于 Web 的飞行射击游戏，模仿雷霆战机玩法，玩家通过击落敌机和特殊物体获得强化道具，击中特殊物体触发答题系统，答对可获得增益效果。

**单页面设计** - 所有功能集中在一个页面，通过游戏状态和 Modal 切换不同界面。

**思政课作业背景** - 本项目是习思想思政课的作业项目，融入"反法西斯胜利"和"中华民族伟大复兴"主题，通过"娱乐+红色教育"的形式，在游戏中传递思政知识。游戏的答题系统将围绕这些主题设计，但开发过程中优先完成核心游戏机制，后续再补充思政内容细节。

---

## 技术栈

### 核心框架
- **Next.js 14+** (App Router) - React 全栈框架
- **React 18+** - UI 库
- **TypeScript** - 类型安全开发

### 样式与 UI
- **SCSS** - CSS 预处理器
- **Ant Design (antd)** - UI 组件库
  - Modal、Button、Progress 等组件
  - 用于答题弹窗、游戏 UI

### 游戏引擎
- **PixiJS v8** - 2D 游戏渲染引擎
  - 高性能 WebGL 渲染
  - 精灵动画、粒子效果
  - 推荐直接使用 PixiJS 而非 react-pixi
  - 原因：游戏循环需要高性能，React 的声明式渲染会引入不必要的开销

### 状态管理
- **Zustand** - 轻量级状态管理
  - 游戏状态 (分数、生命值、等级)
  - 题库管理
  - 用户设置

### 辅助库
- **Howler.js** - 音效管理
- **lodash** - 工具函数

---

## 项目结构

```
xtom3d/
├── app/
│   ├── layout.tsx              # 根布局
│   ├── page.tsx                # 游戏主页面 (唯一页面)
│   └── globals.scss            # 全局样式
├── components/
│   ├── GameCanvas.tsx          # PixiJS 游戏画布容器
│   ├── GameUI.tsx              # 游戏 UI 覆盖层
│   ├── StartOverlay.tsx        # 开始界面覆盖层
│   ├── MenuModal.tsx           # 菜单弹窗
│   ├── InstructionModal.tsx    # 游戏说明弹窗
│   ├── QuestionModal.tsx       # 答题弹窗
│   └── GameOverOverlay.tsx     # 游戏结束覆盖层
├── lib/
│   ├── game/
│   │   ├── Game.ts             # 游戏主类
│   │   ├── entities/
│   │   │   ├── Player.ts       # 玩家飞机
│   │   │   ├── Enemy.ts        # 敌机
│   │   │   ├── Bullet.ts       # 子弹
│   │   │   ├── SpecialItem.ts  # 特殊物体 (触发答题)
│   │   │   └── PowerUp.ts      # 道具
│   │   ├── managers/
│   │   │   ├── CollisionManager.ts  # 碰撞检测
│   │   │   ├── SpawnManager.ts      # 生成管理
│   │   │   └── AudioManager.ts      # 音效管理
│   │   └── utils/
│   │       ├── physics.ts      # 物理计算
│   │       └── constants.ts    # 游戏常量
│   └── questions/
│       ├── questionBank.ts     # 题库数据
│       └── questionManager.ts  # 题目逻辑
├── store/
│   ├── gameStore.ts            # 游戏状态
│   └── uiStore.ts              # UI 状态 (Modal 显示)
├── styles/
│   └── game.module.scss        # 游戏页样式
├── public/
│   └── assets/
│       ├── images/             # 游戏素材
│       └── sounds/             # 音效文件
├── package.json
└── tsconfig.json
```

---

## 游戏状态流转

```
[READY] 准备状态
   ↓ (背景显示游戏场景，无交互)
   ↓ (点击"开始游戏"按钮)
   ↓
[PLAYING] 游戏进行中
   ↓ (玩家飞机出现，敌机开始生成)
   ↓ (击中特殊物体)
   ↓
[PAUSED] 暂停 (答题)
   ↓ (显示答题 Modal)
   ↓ (答题完成)
   ↓
[PLAYING] 继续游戏
   ↓ (生命值为 0)
   ↓
[GAME_OVER] 游戏结束
   ↓ (显示结束界面)
   ↓ (点击"重新开始")
   ↓
[READY] 准备状态
```

---

## 核心功能模块

### 1. 游戏主循环 (lib/game/Game.ts)
```typescript
class Game {
  private app: PIXI.Application
  private player: Player
  private enemies: Enemy[]
  private bullets: Bullet[]
  private specialItems: SpecialItem[]
  
  constructor(canvas: HTMLCanvasElement)
  init(): void                    // 初始化游戏
  update(delta: number): void     // 游戏循环
  handleCollisions(): void        // 碰撞检测
  spawnEnemy(): void             // 生成敌机
  spawnSpecialItem(): void       // 生成特殊物体
  pause(): void                  // 暂停
  resume(): void                 // 继续
  gameOver(): void               // 游戏结束
}
```

### 2. 玩家飞机 (lib/game/entities/Player.ts)
- 移动控制 (键盘/触摸)
- 射击系统
- 生命值管理
- 增益效果
  - 火力提升
  - 护盾
  - 双倍分数

### 3. 敌机系统 (lib/game/entities/Enemy.ts)
- 多种敌机类型
  - 小型敌机 (快速, 低血量)
  - 中型敌机 (中速, 中血量)
  - Boss (慢速, 高血量, 特殊攻击)
- 移动模式
  - 直线下落
  - 曲线飞行
  - 追踪玩家
- 掉落道具

### 4. 特殊物体与答题系统
**触发机制:**
- 随机生成特殊物体 (星星图标)
- 玩家击中后暂停游戏
- 弹出答题 Modal

**答题效果:**
- **答对:** 
  - 飞机火力提升 (子弹数量+1, 伤害+50%)
  - 获得复活机会 (生命+1)
  - 敌人减速 30% (持续 10 秒)
- **答错:**
  - 无惩罚, 继续游戏

### 5. 题库管理 (lib/questions/)
```typescript
interface Question {
  id: string
  question: string
  options: string[]
  correctAnswer: number
  difficulty: 'easy' | 'medium' | 'hard'
  category: string
}

// questionBank.ts
export const questionBank: Question[] = [
  {
    id: 'q1',
    question: '以下哪个是 JavaScript 的数据类型?',
    options: ['String', 'Integer', 'Float', 'Character'],
    correctAnswer: 0,
    difficulty: 'easy',
    category: '编程'
  },
  // ... 更多题目
]
```

---

## 状态管理 (Zustand Stores)

### gameStore.ts

```typescript
interface GameState {
  // 游戏状态
  gameState: 'READY' | 'PLAYING' | 'PAUSED' | 'GAME_OVER'
  score: number
  lives: number
  level: number
  
  // 增益效果
  powerUps: {
    fireRate: number
    damage: number
    shield: boolean
    slowEnemies: boolean
  }
  
  // Actions
  startGame: () => void
  pauseGame: () => void
  resumeGame: () => void
  gameOver: () => void
  resetGame: () => void
  incrementScore: (points: number) => void
  loseLife: () => void
  addLife: () => void
  applyPowerUp: (type: string) => void
}
```

### uiStore.ts

```typescript
interface UIState {
  // Modal 显示状态
  isMenuOpen: boolean
  isInstructionOpen: boolean
  isQuestionOpen: boolean
  
  currentQuestion: Question | null
  
  // Actions
  openMenu: () => void
  closeMenu: () => void
  openInstruction: () => void
  closeInstruction: () => void
  showQuestion: (question: Question) => void
  hideQuestion: () => void
}
```

---

## 单页面布局设计

### 页面结构 (app/page.tsx)

```
┌─────────────────────────────────────────┐
│  [菜单按钮 ☰]                    (右上角) │
├─────────────────────────────────────────┤
│                                         │
│         [PixiJS Canvas 游戏背景]         │
│              (全屏显示)                  │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │   READY 状态覆盖层               │   │
│  │                                 │   │
│  │   ⚡ 雷霆战机 ⚡                  │   │
│  │                                 │   │
│  │   [开始游戏]  [游戏说明]          │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘

PLAYING 状态：
┌─────────────────────────────────────────┐
│  ❤️❤️❤️ 分数: 12450 等级: 3   [☰]       │
├─────────────────────────────────────────┤
│                                         │
│         [游戏进行中]                     │
│           🛩️ 玩家飞机                   │
│         💥 敌机                          │
│         ⭐ 特殊物体                      │
│                                         │
└─────────────────────────────────────────┘
```

### 组件说明

#### 1. GameCanvas (components/GameCanvas.tsx)
- PixiJS 游戏画布容器
- 始终显示游戏场景背景
- 根据游戏状态决定是否允许交互

#### 2. StartOverlay (components/StartOverlay.tsx)
- 仅在 `READY` 状态显示
- 半透明黑色背景遮罩
- 包含：
  - 游戏标题/Logo
  - "开始游戏" 按钮
  - "游戏说明" 按钮

#### 3. GameUI (components/GameUI.tsx)
- 仅在 `PLAYING` 状态显示
- 顶部状态栏：
  - 左侧：生命值显示 (❤️)
  - 中间：当前分数
  - 右侧：等级

#### 4. MenuModal (components/MenuModal.tsx)
- 点击右上角菜单按钮弹出
- 包含选项：
  - 继续游戏 (仅游戏中显示)
  - 重新开始
  - 游戏设置 (音量、音效)
  - 关闭

#### 5. InstructionModal (components/InstructionModal.tsx)
- 点击"游戏说明"按钮弹出
- 显示游戏操作方法和规则

#### 6. QuestionModal (components/QuestionModal.tsx)
- 击中特殊物体时弹出
- 游戏自动暂停
- 显示题目和选项
- 答题后关闭并继续游戏

#### 7. GameOverOverlay (components/GameOverOverlay.tsx)
- 仅在 `GAME_OVER` 状态显示
- 显示最终分数
- "重新开始" 按钮

---

## 游戏机制设计

### 核心玩法定义

#### 游戏类型
横版卷轴式飞行射击游戏（参考雷霆战机），采用单屏固定视野，玩家战机位于屏幕底部，敌机从顶部生成并向下移动。

#### 操作方式
- **PC 端**: 方向键/WASD 控制战机移动，空格键射击
- **移动端**: 触摸拖动战机移动，自动射击
- **射击模式**: 战机默认自动射击，发射单弹道子弹，弹道数量可通过答题增益提升

#### 关卡进度系统
- 采用无限关卡模式，难度随分数递增
- 每累计 1000 分提升一个难度等级
- 难度递增表现：敌机生成频率加快、敌机移动速度提升、敌机血量增加

---

### 战斗系统

#### 玩家战机
- **生命值系统**: 初始生命值 3 点，每次碰撞损失 1 点生命值
- **护盾机制**: 通过答题获得护盾，可抵御 1 次伤害，护盾永久有效直至被触发
- **弹道系统**: 
  - 初始状态：单弹道射击
  - 答题奖励：每次可增加 1 条弹道（最多 3 条弹道）
  - 弹道布局：1 条时居中，2 条时左右对称，3 条时左中右均匀分布
- **移动加速**: 通过答题获得临时加速效果，移动速度提升 50%，持续 8 秒

#### 敌机系统
- **敌机类型**:
  - **小型敌机**: 生命值 1，移动速度快，垂直下落，击落得分 10
  - **中型敌机**: 生命值 3，移动速度中等，可横向移动，击落得分 30
  - **大型敌机**: 生命值 5，移动速度慢，可发射子弹，击落得分 50
- **生成规则**:
  - 游戏开始后 2 秒开始生成敌机
  - 初始生成间隔 2 秒，随难度递增缩短至最低 0.5 秒
  - 生成位置：屏幕顶部随机 X 坐标
  - 敌机配比：小型 60%，中型 30%，大型 10%

#### 碰撞检测
- **玩家子弹 vs 敌机**: 子弹命中敌机造成 1 点伤害，子弹消失
- **敌机子弹 vs 玩家**: 子弹命中玩家损失 1 点生命值（护盾优先抵消）
- **玩家战机 vs 敌机**: 碰撞损失 1 点生命值，敌机摧毁
- **玩家战机 vs 特殊方块**: 触发答题系统

---

### 答题系统

#### 特殊方块机制

**黄色 "?" 方块**（常规增益）
- **生成规则**: 游戏开始后每 20-30 秒随机生成 1 个
- **移动方式**: 从屏幕顶部匀速下落，速度略低于敌机
- **触发条件**: 玩家子弹击中方块
- **效果**: 游戏时停，弹出答题 Modal

**红色 "?" 方块**（特殊清屏）
- **生成规则**: 游戏开始后每 60 秒随机生成 1 个，冷却期间不生成
- **触发条件**: 玩家子弹击中方块
- **效果**: 游戏时停，弹出困难题，答对后触发"东风5C"清屏

#### 答题触发场景

**场景 1: 击中特殊方块**
- 战机子弹击中黄色/红色方块后，游戏立即暂停（时停状态）
- 所有敌机、子弹、方块冻结在当前位置
- 弹出答题 Modal，居中显示题目和选项
- 答题结束后解除时停，游戏恢复运行

**场景 2: 战机死亡复活**
- 玩家生命值归 0 时，触发复活答题
- 每局游戏最多 3 次复活机会
- 弹出"复活答题"提示框，显示剩余复活次数
- 答题时间限制 10 秒（比常规答题更紧迫）

**场景 3: 分数节点触发**
- 分数达到指定节点时自动触发答题：1000、3000、5000、8000、12000 分
- 游戏自动暂停，弹出答题 Modal
- 题目难度与分数节点匹配：
  - 1000/3000 分：简单题
  - 5000/8000 分：中等题
  - 12000+ 分：困难题

#### 答题规则

**时间限制**
- 常规答题：15 秒
- 复活答题：10 秒
- 超时视为答错

**题目类型**
- 题型：单选题（1 题干 + 4 选项）
- 题库范围：反法西斯胜利、中华民族伟大复兴相关知识
- 难度分级：简单、中等、困难

**反馈机制**
- **答对**: 
  - 显示"回答正确！"提示文字（绿色）
  - 播放正向音效
  - 触发对应奖励
- **答错**: 
  - 显示"回答错误"提示文字（红色）
  - 播放提示音效
  - 常规答题：无奖励，游戏继续
  - 复活答题：游戏结束

---

### 奖励与增益系统

#### 常规增益奖励（黄色方块答对）

**弹道增加**
- 效果：战机弹道数量 +1（最多 3 条）
- 持续时间：永久有效
- 视觉反馈：战机周围显示弹道数量图标

**护盾获得**
- 效果：获得 1 层护盾，可抵御 1 次伤害
- 持续时间：永久有效直至触发
- 视觉反馈：战机周围显示护盾特效光环

**临时加速**
- 效果：移动速度提升 50%
- 持续时间：8 秒
- 视觉反馈：战机尾部拖尾效果增强，屏幕顶部显示倒计时

#### 特殊清屏奖励（红色方块答对）

**"东风5C"清屏**
- 效果：
  1. 瞬间清除屏幕内所有敌机和敌机子弹
  2. 所有被清除敌机按正常击落计分
  3. 屏幕产生震动效果（视觉冲击）
- 冷却时间：30 秒（冷却期间不生成红色方块）
- 视觉反馈：全屏白光闪烁 + 爆炸特效

#### 复活奖励（复活答题答对）

- 战机生命值恢复至满值（3 点）
- 额外获得 1 层临时护盾
- 战机产生无敌闪烁效果（持续 2 秒，期间无敌）

#### 分数节点奖励（分数答题答对）

**额外分数奖励**
- 简单题：+100 分
- 中等题：+300 分
- 困难题：+500 分

**随机增益**
- 从弹道增加、护盾获得、临时加速中随机选择 1 种
- 增益立即生效

---

### 难度递增机制

#### 分数等级系统
```
等级 1: 0-999 分
等级 2: 1000-2999 分
等级 3: 3000-4999 分
等级 4: 5000-7999 分
等级 5: 8000+ 分
```

#### 等级对应难度参数

| 等级 | 敌机生成间隔 | 小型敌机速度 | 中型敌机速度 | 大型敌机生成概率 |
|------|--------------|--------------|--------------|------------------|
| 1    | 2.0 秒       | 100 px/s     | 80 px/s      | 5%               |
| 2    | 1.5 秒       | 120 px/s     | 100 px/s     | 10%              |
| 3    | 1.2 秒       | 150 px/s     | 120 px/s     | 15%              |
| 4    | 0.8 秒       | 180 px/s     | 150 px/s     | 20%              |
| 5    | 0.5 秒       | 200 px/s     | 180 px/s     | 25%              |

---

### 计分系统

#### 基础得分
- 击落小型敌机：10 分
- 击落中型敌机：30 分
- 击落大型敌机：50 分

#### 额外得分
- 黄色方块答题答对：+50 分
- 红色方块答题答对：+100 分
- 分数节点答题答对：+100/+300/+500 分

#### 连击系统（可选扩展）
- 连续击落敌机触发连击
- 连击倍率：2 连 x1.2，5 连 x1.5，10 连 x2.0
- 连击中断条件：5 秒内未击落敌机

---

## 游戏交互流程

### 初始加载 (READY 状态)

1. 页面加载，PixiJS 初始化游戏场景
2. 背景显示太空场景 (星空滚动)
3. 右上角显示菜单按钮 (☰)
4. 中央显示 `StartOverlay` 覆盖层：
   - 游戏标题/Logo
   - [开始游戏] 按钮
   - [游戏说明] 按钮
5. 背景可以有装饰性动画，但不出现敌机

### 点击"游戏说明"

1. 弹出 `InstructionModal` (Ant Design Modal)
2. 显示操作说明：
   - 键盘控制：方向键移动，空格键射击
   - 鼠标/触摸：拖动飞机，自动射击
   - 特殊物体：击中可触发答题获得奖励
3. 点击关闭返回 READY 状态

### 点击"开始游戏"

1. `StartOverlay` 淡出消失
2. 游戏状态切换为 `PLAYING`
3. 玩家飞机从屏幕底部中央出现 (淡入动画)
4. 顶部显示 `GameUI` (生命值、分数、等级)
5. 2 秒后开始生成敌机 (从少到多)
6. 玩家可以控制飞机移动和射击

### 游戏进行中 (PLAYING 状态)

1. 玩家飞机持续射击
2. 敌机从顶部随机位置生成并下落
3. 击落敌机获得分数
4. 随机掉落道具 (火力、护盾等)
5. 随机生成特殊物体 (星星图标)

### 击中特殊物体

1. 游戏状态切换为 `PAUSED`
2. 游戏场景冻结 (保持当前画面)
3. 弹出 `QuestionModal` 显示题目
4. 玩家选择答案
5. 显示答题结果 (正确/错误)
6. 应用奖励效果 (若答对)
7. 关闭 Modal，游戏状态恢复为 `PLAYING`

### 点击菜单按钮 (☰)

1. 弹出 `MenuModal`
2. 如果游戏进行中，自动暂停 (状态 → `PAUSED`)
3. 显示选项：
   - 继续游戏 (关闭 Modal 并恢复)
   - 重新开始 (状态 → `READY`)
   - 设置 (音量、音效开关)
   - 关闭
4. 关闭 Modal 后恢复游戏

### 游戏结束 (GAME_OVER 状态)

1. 玩家生命值归零
2. 游戏状态切换为 `GAME_OVER`
3. 显示 `GameOverOverlay`：
   - "游戏结束" 标题
   - 最终分数
   - 最高分记录 (LocalStorage)
   - [重新开始] 按钮
4. 点击重新开始 → 状态回到 `READY`

---

## 开发计划

### Phase 1: 基础搭建

- [ ] 初始化 Next.js 项目
- [ ] 安装依赖：`pixi.js`, `antd`, `sass`, `zustand`
- [ ] 创建项目文件结构
- [ ] 配置 TypeScript 和 SCSS

### Phase 2: 单页面框架

- [ ] 创建 `app/page.tsx` 主页面
- [ ] 集成 PixiJS，创建 `GameCanvas` 组件
- [ ] 实现游戏状态管理 (`gameStore`, `uiStore`)
- [ ] 创建右上角菜单按钮
- [ ] 实现 `StartOverlay` 初始界面

### Phase 3: 游戏核心逻辑

- [ ] 实现玩家飞机 (`Player.ts`)
- [ ] 实现移动控制 (键盘/鼠标)
- [ ] 实现射击系统 (`Bullet.ts`)
- [ ] 创建敌机类 (`Enemy.ts`)
- [ ] 实现敌机生成管理 (`SpawnManager.ts`)
- [ ] 碰撞检测系统 (`CollisionManager.ts`)

### Phase 4: UI 组件

- [ ] 实现 `GameUI` 组件 (分数、生命值显示)
- [ ] 实现 `MenuModal` 组件
- [ ] 实现 `InstructionModal` 组件
- [ ] 实现 `GameOverOverlay` 组件

### Phase 5: 答题系统

- [ ] 创建题库数据 (`questionBank.ts`)
- [ ] 实现特殊物体 (`SpecialItem.ts`)
- [ ] 实现 `QuestionModal` 组件
- [ ] 集成答题逻辑和奖励效果

### Phase 6: 增强与优化

- [ ] 添加音效 (Howler.js)
- [ ] 实现道具系统
- [ ] 添加粒子特效
- [ ] 性能优化
- [ ] 响应式适配 (移动端)
- [ ] LocalStorage 存储最高分

### Phase 7: 部署

- [ ] 部署到 Vercel
- [ ] 域名配置

---

## 技术要点

### PixiJS 集成方式

**为什么选择 PixiJS 而非 react-pixi:**

1. **性能优先** - 游戏需要 60 FPS, React 的虚拟 DOM diff 会引入延迟
2. **游戏循环控制** - requestAnimationFrame 需要精确控制
3. **命令式编程** - 游戏逻辑更适合命令式而非声明式
4. **社区资源** - PixiJS 原生文档和示例更丰富

**集成代码示例:**

```typescript
// components/GameCanvas.tsx
'use client'

import { useEffect, useRef } from 'react'
import * as PIXI from 'pixi.js'
import { Game } from '@/lib/game/Game'
import { useGameStore } from '@/store/gameStore'

export default function GameCanvas() {
  const canvasRef = useRef<HTMLDivElement>(null)
  const gameRef = useRef<Game | null>(null)
  const gameState = useGameStore(state => state.gameState)

  useEffect(() => {
    if (!canvasRef.current) return

    const app = new PIXI.Application({
      width: 800,
      height: 600,
      backgroundColor: 0x000000,
      antialias: true
    })

    canvasRef.current.appendChild(app.view as HTMLCanvasElement)

    const game = new Game(app)
    game.init()
    gameRef.current = game

    return () => {
      game.destroy()
      app.destroy(true)
    }
  }, [])

  // 同步 Zustand 状态到游戏实例
  useEffect(() => {
    if (gameRef.current) {
      gameRef.current.setGameState(gameState)
    }
  }, [gameState])

  return (
    <div 
      ref={canvasRef} 
      className="game-canvas-container"
      style={{ width: '100%', height: '100vh' }}
    />
  )
}
```

### Zustand 状态同步

- **PixiJS → Zustand**: 游戏内部状态 (分数、生命值) 通过 store actions 更新
- **Zustand → PixiJS**: React 组件通过 store 控制游戏状态 (开始、暂停、重置)

---

## 资源需求

### 图片素材

- 玩家飞机: 1 张 (64x64px)
- 敌机: 3 种 (小中大, 各 64x64px)
- 子弹: 2 种 (玩家/敌人, 各 16x32px)
- 特殊物体: 星星图标 (48x48px)
- 道具: 4 种 (各 32x32px)
- 背景: 太空背景图 (循环滚动)

### 音效

- 射击音效
- 爆炸音效
- 道具获取音效
- 背景音乐 (循环)

---

## 总结

### 核心简化点

1. **单页面架构** - 不再有独立的 Home 页和 Game 页，所有功能在一个页面完成
2. **状态驱动 UI** - 通过 `gameState` (READY/PLAYING/PAUSED/GAME_OVER) 控制显示不同组件
3. **背景即游戏** - PixiJS 画布始终显示，初始状态作为背景装饰
4. **Modal 弹窗** - 所有辅助界面 (菜单、说明、答题) 使用 Ant Design Modal
5. **右上角菜单** - 始终可访问的全局菜单入口

### 用户体验流程

1. 打开页面 → 看到游戏背景 + 开始界面
2. 点击开始 → 飞机出现，敌机逐渐生成
3. 击中特殊物体 → 弹出答题，答对获得奖励
4. 生命耗尽 → 显示结束界面，可重新开始
5. 随时点击菜单 → 暂停游戏，查看设置

这种设计更符合现代 Web 游戏的交互模式，简洁流畅。

---
